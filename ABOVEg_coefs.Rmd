
```{r}
rm(list=ls(all=TRUE))

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(nlme))
```

```{r}
data1 <- read_csv("data/shrub_prepped.csv", show_col_types = FALSE) %>%
  mutate(lnAGL = log(AGL.g),
         lnCA = log(CA.m2),
         lnHT = log(Hgt.m))
```

```{r}
fits1 <- data.frame(
  sp_group = c("AMAL", "ARVI"),
  model = c("M1", "M1"),
  type = c("GNLS", "GNLS")
)

fits1
```

```{r}
coef_df <- data.frame(species = as.character(),
                      eqn = as.character(),
                      b1 = as.double(),
                      b2 = as.double(),
                      b3 = as.double())

coef_fn <- function(data, fits) {
  
  species <- unique(fits$sp_group)
  
  for(sp in species) {
    
    sp_data <- data %>% filter(sp_group == sp)
    sp_fit <- fits %>% filter(sp_group == sp)

    if(sp_fit$type[[1]] == "GNLS") {
      
      ctrl_gnls <- gnlsControl(maxIter = 1500, tolerance = 1e-4, minScale = 1e-10, opt = "nlminb")
      
      if(sp_fit$model[[1]] == "M1") {
        
        lm_fit <- lm(lnAGL ~ lnCA + lnHT, data = sp_data)
        b1start <- exp(lm_fit$coef[[1]])
        b2start <- lm_fit$coef[[2]]
        b3start <- lm_fit$coef[[3]]
        
        sp_model <- gnls(AGL.g ~ b1*(CA.m2^b2)*(Hgt.m^b3),
                       start = list(b1 = b1start, b2 = b2start, b3 = b3start),
                       data = sp_data,
                       weights = varPower(),
                       control = ctrl_gnls)
        
        sp_coefs <- data.frame(species = sp_fit$sp_group[[1]],
                               eqn = sp_fit$model[[1]],
                               b1 = as.double(sp_model$coef[[1]]),
                               b2 = as.double(sp_model$coef[[2]]),
                               b3 = as.double(sp_model$coef[[3]]))
        
        coef_df <- rbind(coef_df, sp_coefs)
      
      }
  
    }
  
  }

 return(coef_df)
  
}

coef_fn(data1, fits1)
```

