
---
output: 
  github_document
---

# Shrub biomass estimates

The `ShrubBiomass` function uses allometric equations to estimate above-ground shrub biomass. See "Background information for shrub biomass estimations" below for further details.

## :eight_spoked_asterisk: `ShrubBiomass( )`

### Inputs

1. `shrub_data` A dataframe or tibble. Each row must be an observation of an individual transect at a specific site/plot. Must have at least these columns (column names exact):

    * **site:** Describes the broader location or forest where the data were collected. The class of this variable must be character.
    * **plot:** Identifies the plot in which the individual shrub transect was measured. The class of this variable must be character.
    * **transect:** Identifies the transect on which the specific shrub data were collected. The transect ID Will often be an azimuth from plot center. The class of this variable must be character.
    * **tran_length:** The length of the sampling transect in meters. The class of this variable must be numeric. 
    * **species:** Specifies the species of the individual shrub. Must follow our four-letter species code conventions (see "Species code table" in "Background information for shrub biomass estimations"). The class of this variable must be character.
    * **ht:** Provides the height of the individual shrub in meters. The class of this variable must be numeric. 
    * **crown_axis_1:** Provides the major diameter of the individual shrub in meters (see "Data collection requirements" in "Background information for shrub biomass estimations"). The class of this variable must be numeric. 
    * **crown_axis_2:** Provides the minor diameter of the individual shrub in meters (see "Data collection requirements" in "Background information for shrub biomass estimations"). The class of this variable must be numeric. 
    * **slope:** The slope of the transect in percent (not the slope of the plot). If transect slope was not taken, set the slope to be 0 (which assumes no slope). 

2. `results` Not a variable (column) in the provided dataframe or tibble. Specifies whether the results will be summarized by shrub or by plot. Must be set to either "by_shrub" or "by_plot". The default is set to "by_plot".

*Note: there must be a one-to-one match between time:site:plot identities of tree and fuel data.*

### Outputs

Depends on the results setting: 

* by_shrub: The original dataframe, with a new column:

    * `total_ag_kg`: total above-ground live shrub biomass in kilograms. Includes wood, bark, and leaves. Excludes flowers, seeds, litter, and dead wood. 

* by_plot: A dataframe with plot-level values, with the following columns:
    
    * `site`: as described above
    * `plot`: as described above
    * `total_ag_Mg_ha`: total above-ground live shrub biomass in megagrams per hectare. Includes wood, bark, and leaves. Excludes flowers, seeds, litter, and dead wood.
    * `cover_perc`: total shrub cover in percent
    * `sc_tran_length`: slope-corrected transect length (i.e., horizontal transect length) in meters. This is the total horizontal length of transect sampled for shrubs at the specific site:plot.

### Demonstrations

```{r}
shrub_demo_data <- data.frame(
  site = c("SEKI","SEKI","SEKI","SEKI","SEKI","SEKI","SEKI","SEKI","YOMI","YOMI","YOMI","YOMI","YOMI","YOMI"),
  plot = c("1","1","1","1","2","2","2","2","1","1","1","1","2","2"),
  transect = c("1","1","2","2","1","1","2","2","1","1","2","2","1","2"),
  tran_length = c(20,20,20,20,20,20,20,20,20,20,20,20,20,20),
  species = c("AMAL","AMAL","CEIN","QUSP","AMAL","ARVI","COCO","QUSP","ARVI","ARVI","NODE","NODE","NONE","NONE"),
  ht = c(0.5,0.3,1.5,1.5,1,1.5,1.5,2,1,0.5,1.5,2,NA,NA),
  crown_axis_1 = c(0.5,1,1.5,0.8,1,1.5,0.9,1.5,1,0.8,0.9,1.5,NA,NA),
  crown_axis_2 = c(0.3,0.5,0.8,0.7,0.5,1,0.8,0.8,0.5,0.6,0.8,1.2,NA,NA),
  slope = c(5,5,10,10,0,0,20,20,15,15,5,5,10,10)
)
```

```{r}
# investigate input dataframe
shrub_demo_data
```

*Notice that site = YOMI, plot = 2 is a plot without shrubs. For all plot-level summaries below, this plot without shrubs will have 0 biomass and cover estimates.*

<br>

**Results by shrub:**

```{r}
# call the ShrubBiomass() function in the BerkeleyForestsAnalytics package
shrub_demo1 <- ShrubBiomass(shrub_data = shrub_demo_data,
                            results = "by_shrub")

shrub_demo1
```
<br>

**Results summarized by plot:**

```{r}
# call the ShrubBiomass() function in the BerkeleyForestsAnalytics package
# keep default results (= "by_plot")
shrub_demo2 <- ShrubBiomass(shrub_data = shrub_demo_data)

shrub_demo2
```



# Further data summarization   

The three functions (`CompilePlots`, `CompileSurfaceFuels`, and `CompileShrubs`) summarize data beyond the plot level. These functions are specifically designed to further summarize the outputs from other `BerkeleyForestsAnalytics` functions. The functions recognize simple random sampling and stratified random sampling designs. They also recognize the design of the Fire and Fire Surrogate study. See "Background information for further data summarization" below for further details. 

## :eight_spoked_asterisk: `CompileShrubs( )`

The CompileShrubs function is specifically designed to further summarize outputs from the ShrubBiomass function. Specifically, the function weights biomass and cover estimates by the length of the line transect actually sampled. See “Background information for surface and ground fuel load calculations: Slope-corrected transect length” and “Background information for further data summarization: Weighted equations” below for further details on why and how estimates should be weighted by the line transect length.

### Inputs

1. `shrub_data` A dataframe or tibble. Each row must be an observation of an individual plot. Required columns depend on the sampling design: 

    * All sampling designs (all of these variables must be numeric): 
        * **total_ag_Mg_ha:** Total above-ground live shrub biomass in megagrams per hectare.
        * **cover_perc:** Total shrub cover in percent
        * **sc_tran_length:** Slope-corrected transect length (i.e., horizontal transect length) in meters

    * If sampling design is simple random (all of these variables must be characters): 
        * **time:**  Depending on the project, the time identifier could be the year of measurement, the month of measurement, etc. For example, if plots are remeasured every summer for five years, the time identifier might be the year of measurement. If plots were measured pre- and post-burn, the time identifier might be “pre” or “post”. If time is not important (e.g., all plots were measured once in the same summer), the time identifier might be set to all the same year. Time identifier is very flexible, and should be used as appropriate depending on the design of the study.
        * **site:** Describes the broader location or forest where the data were collected. 
        * **plot:**  Identifies the plot in which the data were collected.
    
    * If sampling design is stratified random (all of these variables must be characters): 
        * **time:** As described above. 
        * **site:** As described above. 
        * **stratum:** Identifies the stratum within site.
        * **plot:**  Identifies the plot within stratum.
        
    * If sampling design is Fire and Fire Surrogate (all of these variables must be characters): 
        * **time:** As desribed above. 
        * **trt_type:** Desicribes the treatment type - control, burn, thin, thin + burn (does not need to follow these exact names).
        * **site:** Describes the compartment where the data were collected.
        * **plot:**  Identifies the plot within compartment.

3. `design` Specifies the sampling design. Must be set to "SRS" (simple random sample), "STRS" (stratified random sample), or "FFS" (Fire and Fire Surrogate). There is no default.

4. `wt_data` Only required for stratified random sampling designs. A dataframe or tibble with the following columns: time (optional), site, stratum, and wh (stratum weight). The default is set to "not_needed", and should be left as such for design = "SRS" or design = "FFS".

5. `fpc_data` An optional dataframe or tibble. Incorporates the finite population correction factor (FPC; see "Background information for further data summarization: Finite population correction factor" below for further details on the definition of the FPC and when the FPC is applicable). The default is set to "not_needed". Required columns depend on the sampling design:
    
    * If sampling design is simple random: 
        * **time:** Optional. As described above. 
        * **site:** As desicribed above. 
        * **N:** Total number of plots in the entire population. For example, if you have a 60 hectare tract and 0.1 hectare plots, N would be 600. 
        * **n:** Number of plots in the sample. 
    
    * If sampling design is stratified random: 
        * **time:** Optional. As described above. 
        * **site:** As desicribed above. 
        * **stratum:** As described above. 
        * **N:** As described above. 
        * **n:** As described above.
        
    * If sampling design is Fire and Fire Surrogate:
        * **time:** Optional. As described above. 
        * **trt_type:** As desicribed above. 
        * **site:** As described above. 
        * **N:** As described above. 
        * **n:** As described above.

### Outputs

Depends on the sampling design: 

* Simple random sampling: a dataframe with site-level summaries.

* Stratified random sampling: a list with two components: (1) a dataframe with stratum-level summaries and (2) a dataframe with site-level summaries.

* Fire and Fire Surrogate: a list with two components: (1) a dataframe with site-level (i.e., compartment-level) summaries and (2) a dataframe with treatment-level summaries.

### Demonstrations

```{r}
compilation_strs_shrub_demo <- data.frame(
  time = c("pre", "pre", "pre", "pre", "pre", "pre", "pre", "pre", "pre", "post", "post", "post", "post", "post", "post", "post", "post", "post"),
  site = c("SEKI", "SEKI", "SEKI", "SEKI", "SEKI", "YOMI", "YOMI", "YOMI", "YOMI", "SEKI", "SEKI", "SEKI", "SEKI", "SEKI", "YOMI", "YOMI", "YOMI", "YOMI"),
  stratum = as.character(c(1,1,1,2,2,1,1,2,2,1,1,1,2,2,1,1,2,2)),
  plot = as.character(c(1,2,3,1,2,1,2,1,2,1,2,3,1,2,1,2,1,2)),
  total_ag_Mg_ha = c(1,1,2,3,1,0,3,2,2,0,1,1,0,0,0,2,1,2),
  cover_perc = c(15,20,30,35,15,0,25,20,20,0,15,10,0,0,0,15,10,20),
  sc_tran_length = c(28,28,29,29,26,30,30,30,30,28,28,29,29,26,30,30,30,30)
)

compilation_srs_shrub_demo <- data.frame(
  time = c("pre", "pre", "pre", "pre", "pre", "pre", "pre", "pre", "pre", "post", "post", "post", "post", "post", "post", "post", "post", "post"),
  site = c("SEKI", "SEKI", "SEKI", "SEKI", "SEKI", "YOMI", "YOMI", "YOMI", "YOMI", "SEKI", "SEKI", "SEKI", "SEKI", "SEKI", "YOMI", "YOMI", "YOMI", "YOMI"),
  plot = as.character(c(1,2,3,4,5,1,2,3,4,1,2,3,4,5,1,2,3,4)),
  total_ag_Mg_ha = c(1,1,2,3,1,0,3,2,2,0,1,1,0,0,0,2,1,2),
  cover_perc = c(15,20,30,35,15,0,25,20,20,0,15,10,0,0,0,15,10,20),
  sc_tran_length = c(28,28,29,29,26,30,30,30,30,28,28,29,29,26,30,30,30,30)
)
```

**Simple random sampling design:**

```{r}
# investigate input compilation_srs_shrub_demo
compilation_srs_shrub_demo
```

```{r}
# call the CompileShrubs() function in the BerkeleyForestsAnalytics package
# keep default wt_data (= "not_needed") and fpc_data (= "not_needed)
srs_shrub_demo <- CompileShrubs(shrub_data = compilation_srs_shrub_demo,
                                design = "SRS")

srs_shrub_demo
```

<br>

**Stratified random sampling design:**

```{r}
# investigate input compilation_strs_shrub_demo
compilation_strs_shrub_demo
```

```{r}
# investigate input wt_data
compilation_wt_demo
```

```{r}
# call the CompileShrubs() function in the BerkeleyForestsAnalytics package
# keep default fpc_data (= "not_needed)
strs_shrub_demo <- CompileShrubs(shrub_data = compilation_strs_shrub_demo,
                                 design = "STRS",
                                 wt_data = compilation_wt_demo)

strs_shrub_demo
```

<br>

# Background information for shrub estimations

## Species code table 

All shrub species currently included/recognized in the `ShrubBiomass()` function are listed in the table below.

|4-letter code|scientific name|common name|
|:---|:---|:---|
|AMAL|*Amelanchier alnifolia*|serviceberry|
|ARPA|*Arctostaphylos patula*|greenleaf manzanita|
|ARVI|*Arctostaphylos viscida*|whiteleaf manzanita|
|CECO|*Ceanothus cordulatus*|whitethorn|
|CEIN|*Ceanothus integerrimus*|deerbrush|
|CEVE|*Ceanothus velutinus*|tobacco brush|
|CESP|*Ceanothus* spp.|other Ceanothus species|
|CHSP|*Chrysothamnus* spp.|rabbitbrush species|
|CHSE|*Chrysolepis sempervirens*|Sierra chinquapin|
|COSP|*Cornus* spp.|dogwood species|
|COCO|*Corylus cornuta* ssp. *californica*|beaked hazelnut|
|LEDA|*Leucothoe davisiae*|Sierra laurel|
|NODE|*Notholithocarpus densiflorus*|tan-oak|
|QUSP|*Quercus* spp.|oak species|
|RISP|*Ribies* spp.|currant and gooseberry species|
|OTHER|NA|other or unknown species|

*Note: Four-letter species codes are generally the first two letters of the genus followed by the first two letters of the species.*

## General workflow

**Step 1:** Estimate shrub-level biomass using allometric equations 

The allometric models follow one of two forms:

\(AGB_i = a*CA_i^b*HT_i^c\) OR \(AGB_i = a*CA_i^b\)

*Where*

* AGB is aboveground live shrub biomass (including wood, bark, and leaves) in g for shrub i
* CA is crown area in \(m^2\) for shrub i, calculated as an ellipse using the major and minor diameters of shrub i
* HT is height in m for shrub i
* a, b, and c are the estimated coefficients for each shrub species 

**Step 2:** Estimate values on a per area basis 

\(Y_p = \frac{1}{L_p}*\sum(\frac{Q_{i,p}}{D_{i,p}})\)

*Where*

* Y is a quantity on a per-area basis for plot p (here either aboveground live biomass in \(kg/m^2\) OR percent cover)
* L is the total slope-corrected transect length in m for plot p 
* Q is the quantity measured on the \(i^{th}\) shrub encountered (here either aboveground live biomass converted from g to kg OR crown area in \(m^2\))
* D is the effective diameter in m of the \(i^{th}\) shrub, which is calculated as the perimeter of the shrub divided by \(pi\)

**Step 3:** Convert units

For aboveground live biomass, convert units from \(kg/m^2\) to \(Mg/ha\)

**Further resources:**

* For more detail on the overall approach see: Battles, J.J., J.G. Dushoff, and T.J. Fahey. 1996. Line intersect sampling of forest canopy gaps. *Forest Science* 42(2): 131-138.
* For more detail on slope-corrected transect lengths see "Background information for surface and ground fuel load calculations: Slope-corrected transect length" in the README file for BerkeleyForestsAnalytics.
* For more detail on the finite population correction factor see "Background information for further data summarization: Fintite population correction factor" in the README file for BerkeleyForestsAnalytics.
* For more detail on data summarization beyond the plot level (including further details on why and how estimates are weighted by the line transect length) see "Background information for further data summarization: Weighted equations used in CompileSurfaceFuels function" in the README file for BerkeleyForestsAnalytics.

Link to BerkeleyForestsAnalytics README file [HERE](https://github.com/kearutherford/BerkeleyForestsAnalytics)

## General setup for shrub data collection 

* Each plot has one or more shrub transects. The number of transects per plot and the length of the transects will vary by protocol. 
* On each transect, record the following information for each shrub that intersects the transect:
    * Species 
    * Major shrub diameter: the maximum crown width of the individual 
    * Minor shrub diameter: the crown width of the individual, perpendicular to the axis of the maximum width 
    * Shrub height: the average height of the shrub
* As an example: Shrubs are sampled along two perpendicular 30m transects intersecting at plot center (see image below).

<br>

<img src = "man/figures/shrub_diagram.png" />

<br> 
